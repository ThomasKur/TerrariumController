@page "/"
@using TerrariumController.Services
@using TerrariumController.Models
@rendermode InteractiveServer
@inject ISensorService SensorService
@inject IRelayService RelayService
@inject ISettingsService SettingsService
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<PageTitle>Terrarium Controller</PageTitle>

<div class="dashboard">
    <header class="hero">
        <div>
            <p class="eyebrow">Terrarium Controller</p>
            <h1>Live Environment Overview</h1>
            <p class="lede">Monitor temperatures, humidity, and daylight schedule at a glance.</p>
        </div>
        <div class="hero-meta">
            <div class="meta-item">
                <span class="meta-label">Last Updated</span>
                <span class="meta-value">@DateTime.Now.ToLocalTime().ToString("HH:mm")</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Hysteresis</span>
                <span class="meta-value">@CurrentSettings?.TemperatureHysteresis.ToString("F1")°C</span>
            </div>
        </div>
    </header>

    <section class="sensor-grid">
        @foreach (var reading in CurrentReadings.OrderBy(r => r.SensorId))
        {
            <div class="card sensor-card">
                <div class="card-header">
                    <span class="pill">Sensor @reading.SensorId</span>
                    <span class="label">@reading.Label</span>
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value">@(reading.Temperature?.ToString("F1") ?? "--")°C</div>
                        <div class="metric-label">Temperature</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">@(reading.Humidity?.ToString("F0") ?? "--")%</div>
                        <div class="metric-label">Humidity</div>
                    </div>
                </div>
                <div class="threshold">
                    <label>Threshold (@GetThreshold(reading.SensorId)°C)</label>
                    <input type="range" min="15" max="35" step="0.1" value="@GetThreshold(reading.SensorId)" @onchange="@((ChangeEventArgs e) => UpdateThreshold(reading.SensorId, double.Parse(e.Value?.ToString() ?? "29")))" />
                </div>
            </div>
        }
    </section>

    <section class="split">
        <div class="card scheduler">
            <div class="card-header">
                <span class="pill">Relay 4</span>
                <span class="label">Daylight Schedule</span>
            </div>
            <div class="schedule-grid">
                <div class="input-group">
                    <label>On</label>
                    <input type="time" value="@OnTime" @onchange="@((ChangeEventArgs e) => OnTime = e.Value?.ToString() ?? OnTime)" />
                </div>
                <div class="input-group">
                    <label>Off</label>
                    <input type="time" value="@OffTime" @onchange="@((ChangeEventArgs e) => OffTime = e.Value?.ToString() ?? OffTime)" />
                </div>
                <button class="primary" @onclick="SaveSchedule">Save</button>
            </div>
        </div>

        <div class="card camera">
            <div class="card-header">
                <span class="pill">Camera</span>
                <span class="label">Live Feed</span>
            </div>
            <div class="camera-frame">
                <img id="camera-feed" alt="Camera Feed" />
            </div>
        </div>
    </section>
</div>

<style>
    .dashboard {
        display: flex;
        flex-direction: column;
        gap: 18px;
        color: #e7edf7;
    }

    .hero {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
    }

    .eyebrow {
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-size: 12px;
        color: #7bd7ff;
        margin: 0 0 6px 0;
    }

    .hero h1 {
        margin: 0 0 6px 0;
        font-size: 28px;
        color: #f5f9ff;
    }

    .lede {
        margin: 0;
        color: #a6b3c9;
    }

    .hero-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 12px;
    }

    .meta-item {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        padding: 12px 14px;
        min-width: 140px;
    }

    .meta-label {
        display: block;
        font-size: 12px;
        color: #8ea0bd;
    }

    .meta-value {
        font-weight: 600;
        color: #f5f9ff;
    }

    .sensor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
    }

    .card {
        background: linear-gradient(160deg, rgba(34, 45, 64, 0.8), rgba(20, 28, 43, 0.9));
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35), inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .pill {
        font-size: 12px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(123, 215, 255, 0.12);
        color: #7bd7ff;
        border: 1px solid rgba(123, 215, 255, 0.3);
    }

    .label {
        color: #cfd9e8;
        font-weight: 600;
    }

    .metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .metric-value {
        font-size: 26px;
        font-weight: 600;
        color: #f5f9ff;
    }

    .metric-label {
        font-size: 12px;
        color: #8ea0bd;
    }

    .threshold {
        margin-top: 12px;
        display: grid;
        gap: 6px;
    }

    .threshold label {
        color: #a6b3c9;
        font-size: 13px;
    }

    .threshold input[type=range] {
        accent-color: #7bd7ff;
    }

    .split {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 14px;
    }

    .schedule-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
        align-items: end;
    }

    .input-group {
        display: grid;
        gap: 6px;
    }

    .input-group label {
        font-size: 12px;
        color: #8ea0bd;
    }

    input[type=time], input[type=number], input[type=text], input[type=range] {
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #f5f9ff;
        border-radius: 10px;
        padding: 10px 12px;
    }

    input[type=range] {
        padding: 0;
    }

    .primary {
        padding: 12px;
        background: linear-gradient(135deg, #7bd7ff, #58c2f0);
        color: #0b1018;
        border: none;
        border-radius: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
    }

    .primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 28px rgba(123, 215, 255, 0.35);
    }

    .camera-frame {
        margin-top: 10px;
        background: #0b1018;
        border-radius: 12px;
        border: 1px solid rgba(123, 215, 255, 0.15);
        overflow: hidden;
    }

    .camera-frame img {
        display: block;
        width: 100%;
        height: auto;
    }

    @@media (max-width: 768px) {
        .hero {
            flex-direction: column;
        }

        .hero-meta {
            width: 100%;
        }
    }
</style>

@code {
    private List<SensorReadingModel> CurrentReadings = new();
    private string OnTime = "08:00";
    private string OffTime = "20:00";
    private Settings? CurrentSettings;

    protected override async Task OnInitializedAsync()
    {
        CurrentSettings = await SettingsService.GetSettingsAsync();
        OnTime = CurrentSettings.Relay4OnTime;
        OffTime = CurrentSettings.Relay4OffTime;
        await RefreshReadings();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var uri = new Uri(NavigationManager.Uri);
            var cameraUrl = $"http://{uri.Host}:8080/stream.mjpg";
            await JS.InvokeVoidAsync("setCameraUrl", cameraUrl);
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task RefreshReadings()
    {
        var readings = await SensorService.GetLatestReadingsAsync();
        CurrentReadings = readings.Select(r => new SensorReadingModel
        {
            SensorId = r.SensorId,
            Label = r.Label ?? $"Sensor {r.SensorId}",
            Temperature = r.Temperature,
            Humidity = r.Humidity,
            IsValid = r.IsValid
        }).ToList();
    }

    private double GetThreshold(int sensorId)
    {
        if (CurrentSettings == null) return 29.0;
        return sensorId switch
        {
            1 => CurrentSettings.Threshold1Temperature,
            2 => CurrentSettings.Threshold2Temperature,
            3 => CurrentSettings.Threshold3Temperature,
            _ => 29.0
        };
    }

    private async Task UpdateThreshold(int sensorId, double value)
    {
        if (CurrentSettings == null) return;

        switch (sensorId)
        {
            case 1:
                CurrentSettings.Threshold1Temperature = value;
                break;
            case 2:
                CurrentSettings.Threshold2Temperature = value;
                break;
            case 3:
                CurrentSettings.Threshold3Temperature = value;
                break;
        }

        await SettingsService.UpdateSettingsAsync(CurrentSettings);
    }

    private async Task SaveSchedule()
    {
        if (CurrentSettings != null)
        {
            CurrentSettings.Relay4OnTime = OnTime;
            CurrentSettings.Relay4OffTime = OffTime;
            await SettingsService.UpdateSettingsAsync(CurrentSettings);
        }
    }

    private class SensorReadingModel
    {
        public int SensorId { get; set; }
        public string Label { get; set; } = "";
        public double? Temperature { get; set; }
        public double? Humidity { get; set; }
        public bool IsValid { get; set; }
    }
}
